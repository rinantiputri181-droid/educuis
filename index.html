<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Kuis & Ujian Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f0c29;
            background-image: linear-gradient(to top, #302b63, #24243e, #0f0c29);
            background-attachment: fixed;
        }
        #app-container { position: relative; z-index: 1; }
        #stars-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: 0; }
        .star { position: absolute; background-color: white; border-radius: 50%; animation-name: twinkle; animation-iteration-count: infinite; box-shadow: 0 0 4px #fff, 0 0 8px #fff; }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1); } }
        .view { display: none; }
        .view.active { display: block; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .character-card { transition: transform 0.2s, box-shadow 0.2s; }
        .character-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(96, 165, 250, 0.5), 0 4px 6px -2px rgba(96, 165, 250, 0.25); }
        .character-card.selected { transform: translateY(-5px) scale(1.05); box-shadow: 0 0 0 4px #3b82f6; }
        .loader { width: 20px; height: 20px; border: 3px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-white flex items-center justify-center min-h-screen p-4">

    <div id="stars-container"></div>

    <div id="app-container" class="w-full max-w-4xl mx-auto">
        
        <!-- Language Selection View -->
        <div id="lang-select-view" class="view active text-center bg-gray-800/80 backdrop-blur-sm p-8 rounded-2xl shadow-2xl">
            <h1 class="text-3xl font-bold mb-2">Selamat Datang / Welcome</h1>
            <p class="text-gray-400 mb-8">Pilih Bahasa / Select Language</p>
            <div class="flex justify-center gap-4">
                <button onclick="setLanguage('id')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">Bahasa Indonesia</button>
                <button onclick="setLanguage('en')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">English</button>
            </div>
        </div>

        <!-- Role Selection View -->
        <div id="role-select-view" class="view text-center bg-gray-800/80 backdrop-blur-sm p-8 rounded-2xl shadow-2xl">
            <h1 id="role-title" class="text-3xl font-bold mb-8"></h1>
            <div class="flex flex-col md:flex-row justify-center gap-4">
                <button onclick="showView('teacher-view')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-8 rounded-lg transition-transform transform hover:scale-105">
                    <span id="teacher-btn-text"></span>
                </button>
                <button onclick="showView('join-quiz-view')" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 px-8 rounded-lg transition-transform transform hover:scale-105">
                    <span id="student-btn-text"></span>
                </button>
            </div>
             <button onclick="showView('lang-select-view')" class="mt-8 text-sm text-gray-400 hover:text-white" id="back-to-lang-btn"></button>
        </div>
        
        <!-- Teacher View -->
        <div id="teacher-view" class="view bg-gray-800/80 backdrop-blur-sm p-6 md:p-8 rounded-2xl shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h1 id="teacher-title" class="text-2xl md:text-3xl font-bold"></h1>
                <div>
                    <button onclick="showInstructions()" class="text-sm bg-gray-700 hover:bg-gray-600 py-2 px-4 rounded-lg mr-2" id="instructions-btn"></button>
                    <button onclick="showView('role-select-view')" class="text-sm bg-gray-700 hover:bg-gray-600 py-2 px-4 rounded-lg" id="back-to-role-btn"></button>
                </div>
            </div>

            <div class="bg-gray-900/80 p-6 rounded-xl mb-6">
                <h2 id="add-question-title" class="text-xl font-semibold mb-4"></h2>
                <form id="add-question-form" class="space-y-4">
                    <div>
                        <label for="question-text" class="block mb-2 text-sm font-medium text-gray-300" id="question-label"></label>
                        <textarea id="question-text" rows="3" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500" required></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="option-a" class="bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
                        <input type="text" id="option-b" class="bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
                        <input type="text" id="option-c" class="bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
                        <input type="text" id="option-d" class="bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="correct-answer" class="block mb-2 text-sm font-medium text-gray-300" id="correct-answer-label"></label>
                            <select id="correct-answer" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5">
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                            </select>
                        </div>
                        <div>
                            <label for="points" class="block mb-2 text-sm font-medium text-gray-300" id="points-label"></label>
                            <input type="number" id="points" value="10" min="1" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg" id="add-question-btn"></button>
                </form>
            </div>

            <div>
                <h2 id="question-list-title" class="text-xl font-semibold mb-4"></h2>
                <div id="question-list" class="space-y-4 max-h-64 overflow-y-auto pr-2">
                    <!-- Questions will be dynamically inserted here -->
                </div>
            </div>
            
            <div class="mt-8 text-center">
                <button onclick="publishQuiz()" id="publish-quiz-btn" class="flex justify-center items-center gap-2 w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition-transform transform hover:scale-105 disabled:bg-gray-600 disabled:cursor-not-allowed">
                </button>
            </div>
        </div>
        
        <!-- Token Display View (for Teacher) -->
        <div id="token-display-view" class="view text-center bg-gray-800/80 backdrop-blur-sm p-8 rounded-2xl shadow-2xl">
            <h1 id="token-success-title" class="text-3xl font-bold mb-4 text-green-400"></h1>
            <p id="token-share-info" class="text-gray-300 mb-6"></p>
            <div class="bg-gray-900/80 p-6 rounded-xl mb-8 inline-flex items-center gap-4">
                <span id="quiz-token" class="text-4xl font-bold tracking-widest text-yellow-300"></span>
                <button onclick="copyToken()" id="copy-token-btn" class="bg-blue-600 hover:bg-blue-700 p-3 rounded-lg">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                </button>
            </div>
            <div>
                <button onclick="resetTeacherPanel()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg" id="create-new-quiz-btn"></button>
            </div>
        </div>

        <!-- Join Quiz View (for Student) -->
        <div id="join-quiz-view" class="view text-center bg-gray-800/80 backdrop-blur-sm p-8 rounded-2xl shadow-2xl">
            <h1 id="join-title" class="text-3xl font-bold mb-6"></h1>
            <form id="join-quiz-form">
                <input type="text" id="token-input" class="w-full max-w-sm mx-auto bg-gray-700 border border-gray-600 text-white text-center rounded-lg p-4 text-2xl uppercase tracking-widest focus:ring-blue-500 focus:border-blue-500 mb-4" required>
                <p id="join-error-msg" class="text-red-400 h-6 mb-4"></p>
                <button type="submit" id="join-quiz-btn" class="flex justify-center items-center gap-2 w-full max-w-sm bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-8 rounded-lg transition-transform transform hover:scale-105 disabled:bg-gray-600"></button>
            </form>
            <button onclick="showView('role-select-view')" class="mt-8 text-sm text-gray-400 hover:text-white" id="back-to-role-from-join-btn"></button>
        </div>

        <!-- Character Selection View -->
        <div id="character-select-view" class="view bg-gray-800/80 backdrop-blur-sm p-6 md:p-8 rounded-2xl shadow-2xl text-center">
            <h1 id="character-title" class="text-3xl font-bold text-center mb-6"></h1>
            
            <div class="mb-6">
                <label for="player-name" id="player-name-label" class="block mb-2 text-sm font-medium text-gray-300"></label>
                <input type="text" id="player-name" class="w-full max-w-sm mx-auto bg-gray-700 border border-gray-600 text-white text-center rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div id="character-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                <!-- Characters will be dynamically added here -->
            </div>

            <div class="mt-8">
                <button id="start-quiz-btn" onclick="startQuiz()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition-transform transform hover:scale-105 disabled:bg-gray-600 disabled:cursor-not-allowed disabled:transform-none" disabled>
                    <span id="start-quiz-btn-text">Mulai Kuis</span>
                </button>
                 <button onclick="showView('join-quiz-view')" class="mt-4 text-sm text-gray-400 hover:text-white block mx-auto" id="back-to-role-from-char-btn"></button>
            </div>
        </div>

        <!-- Student Quiz View -->
        <div id="student-view" class="view bg-gray-800/80 backdrop-blur-sm p-6 md:p-8 rounded-2xl shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-3">
                     <img id="quiz-avatar" src="" alt="Avatar" class="w-12 h-12 rounded-full bg-gray-700 object-cover">
                     <div>
                        <p id="player-name-display" class="text-lg font-bold"></p>
                        <h2 id="quiz-title" class="text-md text-gray-300"></h2>
                        <p id="second-chance-info" class="text-sm text-yellow-400 font-medium"></p>
                     </div>
                </div>
                <p id="quiz-progress" class="text-gray-400 font-medium"></p>
            </div>
            <div class="bg-gray-900/80 p-6 rounded-xl">
                <p id="quiz-question" class="text-xl mb-6 min-h-[60px]"></p>
                <div id="quiz-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Options will be dynamically inserted here -->
                </div>
            </div>
        </div>

        <!-- Results View -->
        <div id="results-view" class="view text-center bg-gray-800/80 backdrop-blur-sm p-8 rounded-2xl shadow-2xl">
            <img id="result-character-img" src="" class="w-32 h-32 mx-auto rounded-full mb-4 border-4 border-green-400">
            <p id="result-player-name" class="text-2xl font-bold"></p>
            <h1 id="results-title" class="text-xl font-medium text-gray-300 mb-4"></h1>
            <p id="final-score" class="text-6xl font-bold text-green-400 mb-2"></p>
            <p id="score-details" class="text-gray-300 mb-8"></p>
            <div class="flex justify-center gap-4">
                <button onclick="showCharacterSelection()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg" id="retry-btn"></button>
                <button onclick="showView('role-select-view')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg" id="main-menu-btn"></button>
            </div>
        </div>
        
    </div>

    <!-- Instructions Modal -->
    <div id="instructions-modal" class="modal-overlay">
        <div class="bg-gray-800/80 backdrop-blur-sm p-8 rounded-2xl shadow-2xl w-11/12 max-w-2xl max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-2xl font-bold"></h2>
                <button onclick="closeInstructions()" class="text-3xl">&times;</button>
            </div>
            <div id="modal-content" class="prose prose-invert text-gray-300">
                <!-- Instructions content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import fungsi yang dibutuhkan dari Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES & STATE ---
        window.currentLanguage = 'id';
        window.questions = []; // Untuk guru membuat kuis
        window.studentQuestions = []; // Untuk siswa mengerjakan kuis
        window.wronglyAnsweredQuestions = [];
        window.retryQuestions = [];
        window.currentQuestionIndex = 0;
        window.score = 0;
        window.maxRetries = 0;
        window.selectedCharacter = null;
        window.playerName = '';
        window.isInRetryRound = false;
        let db, auth; // Variabel untuk instance Firebase

        // --- CHARACTERS ---
        const characters = [
            { id: 'upin', name: 'Upin', img: 'https://i.ibb.co/6rW8zC3/upin.png' },
            { id: 'ipin', name: 'Ipin', img: 'https://i.ibb.co/hK0W7cT/ipin.png' },
            { id: 'mail', name: 'Mail', img: 'https://i.ibb.co/yQW2W3T/mail.png' },
            { id: 'ehsan', name: 'Ehsan', img: 'https://i.ibb.co/8Y4y5S6/ehsan.png' },
            { id: 'fizi', name: 'Fizi', img: 'https://i.ibb.co/kH2T3Nn/fizi.png' },
            { id: 'jarjit', name: 'Jarjit', img: 'https://i.ibb.co/z5N2h7J/jarjit.png' },
            { id: 'mei', name: 'Mei Mei', img: 'https://i.ibb.co/Qv8B1fF/meimei.png' },
            { id: 'susanti', name: 'Susanti', img: 'https://i.ibb.co/wYyK3T5/susanti.png' },
            { id: 'ros', name: 'Kak Ros', img: 'https://i.ibb.co/GcvfC0T/kakros.png' },
            { id: 'opah', name: 'Opah', img: 'https://i.ibb.co/n6z7v4p/opah.png' },
        ];
        
        // --- TRANSLATIONS ---
        const translations = {
            id: {
                roleTitle: "Pilih Peran Anda", teacherBtn: "Saya Guru (Buat Kuis)", studentBtn: "Saya Siswa (Ikut Kuis)", backToLang: "Kembali ke Pilih Bahasa", teacherTitle: "Panel Guru", instructionsBtn: "Panduan", backToRole: "Kembali", addQuestionTitle: "Tambah Soal Baru", questionLabel: "Teks Pertanyaan", optionPlaceholder: (opt) => `Pilihan ${opt}`, correctAnswerLabel: "Jawaban Benar", pointsLabel: "Poin", addQuestionBtn: "Tambah Soal", questionListTitle: "Daftar Soal", deleteBtn: "Hapus", publishBtn: "Selesaikan & Dapatkan Kode Kuis", tokenSuccessTitle: "Kuis Berhasil Dipublikasi!", tokenShareInfo: "Bagikan kode ini kepada siswa Anda untuk bergabung:", copyBtnTitle: "Salin Kode", copySuccessMsg: "Kode disalin!", createNewQuizBtn: "Buat Kuis Baru", joinTitle: "Masuk ke Ruang Kuis", tokenInputPlaceholder: "MASUKKAN KODE", joinQuizBtn: "Gabung", joiningText: "Mencari...", backToRoleFromJoin: "Kembali ke Pilih Peran", joinErrorMsg: "Kode salah atau kuis tidak ditemukan.", characterTitle: "Siapkan Dirimu!", playerNameLabel: "Masukkan Namamu", playerNamePlaceholder: "Contoh: Budi", startQuizBtn: "Mulai Kuis", backToRoleFromChar: "Kembali", quizTitle: "Kuis Sedang Berlangsung", retryRoundTitle: "Ronde Kesempatan Kedua!", progressText: (current, total) => `Soal ${current} dari ${total}`, retryProgressText: (current, total) => `Soal Bonus ${current} dari ${total}`, resultsTitle: "Kuis Selesai!", finalScore: "Skor Akhir", scoreDetails: (total, maxScore) => `Total Poin yang Diperoleh: ${total}/${maxScore}`, retryBtn: "Main Lagi", mainMenuBtn: "Menu Utama", modalTitle: "Panduan Penggunaan Aplikasi", modalContent: `<h3 class="font-bold text-xl mb-2 text-white">Untuk Guru:</h3><ol class="list-decimal list-inside space-y-2"><li>Pilih peran "Saya Guru".</li><li>Isi formulir untuk menambah soal satu per satu. Soal akan disimpan secara online.</li><li>Setelah semua soal ditambahkan, klik tombol "Selesaikan & Dapatkan Kode Kuis".</li><li>Bagikan kode yang muncul kepada siswa.</li></ol><h3 class="font-bold text-xl mt-6 mb-2 text-white">Untuk Siswa:</h3><ol class="list-decimal list-inside space-y-2"><li>Pilih peran "Saya Siswa".</li><li>Masukkan Kode Kuis yang diberikan oleh guru dari perangkat mana pun.</li><li>Masukkan namamu dan pilih karakter favoritmu.</li><li>Jawab semua pertanyaan hingga selesai.</li><li><b>Ronde Kesempatan Kedua:</b> Jika salah menjawab, soal-soal tersebut akan diulang di akhir sebagai ronde bonus untuk memperbaiki skormu.</li></ol>`
            },
            en: {
                roleTitle: "Select Your Role", teacherBtn: "I'm a Teacher (Create Quiz)", studentBtn: "I'm a Student (Join Quiz)", backToLang: "Back to Language Select", teacherTitle: "Teacher Panel", instructionsBtn: "Guide", backToRole: "Back", addQuestionTitle: "Add New Question", questionLabel: "Question Text", optionPlaceholder: (opt) => `Option ${opt}`, correctAnswerLabel: "Correct Answer", pointsLabel: "Points", addQuestionBtn: "Add Question", questionListTitle: "Question List", deleteBtn: "Delete", publishBtn: "Finish & Get Quiz Code", tokenSuccessTitle: "Quiz Published Successfully!", tokenShareInfo: "Share this code with your students to join:", copyBtnTitle: "Copy Code", copySuccessMsg: "Code copied!", createNewQuizBtn: "Create New Quiz", joinTitle: "Join Quiz Room", tokenInputPlaceholder: "ENTER CODE", joinQuizBtn: "Join", joiningText: "Joining...", backToRoleFromJoin: "Back to Role Select", joinErrorMsg: "Invalid code or quiz not found.", characterTitle: "Get Ready!", playerNameLabel: "Enter Your Name", playerNamePlaceholder: "Example: John", startQuizBtn: "Start Quiz", backToRoleFromChar: "Back", quizTitle: "Quiz in Progress", retryRoundTitle: "Second Chance Round!", progressText: (current, total) => `Question ${current} of ${total}`, retryProgressText: (current, total) => `Bonus Question ${current} of ${total}`, resultsTitle: "Quiz Finished!", finalScore: "Final Score", scoreDetails: (total, maxScore) => `Total Points Earned: ${total}/${maxScore}`, retryBtn: "Play Again", mainMenuBtn: "Main Menu", errorTitle: "Oops!", errorMessage: "No questions have been added by the teacher yet. Please ask the teacher to create the quiz first.", backFromError: "Back to Menu", modalTitle: "Application Guide", modalContent: `<h3 class="font-bold text-xl mb-2 text-white">For Teachers:</h3><ol class="list-decimal list-inside space-y-2"><li>Select the "I'm a Teacher" role.</li><li>Fill out the form to add questions. They will be saved online.</li><li>Once all questions are added, click "Finish & Get Quiz Code".</li><li>Share the generated code with your students.</li></ol><h3 class="font-bold text-xl mt-6 mb-2 text-white">For Students:</h3><ol class="list-decimal list-inside space-y-2"><li>Select the "I'm a Student" role.</li><li>Enter the Quiz Code from any device.</li><li>Enter your name and choose your favorite character.</li><li>Answer all the questions.</li><li><b>Second Chance Round:</b> Incorrectly answered questions will be repeated at the end as a bonus round.</li></ol>`
            }
        };

        // --- FIREBASE SETUP ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "GANTI_DENGAN_API_KEY_ANDA",
            authDomain: "GANTI_DENGAN_AUTH_DOMAIN_ANDA",
            projectId: "GANTI_DENGAN_PROJECT_ID_ANDA",
            storageBucket: "GANTI_DENGAN_STORAGE_BUCKET_ANDA",
            messagingSenderId: "GANTI_DENGAN_MESSAGING_SENDER_ID_ANDA",
            appId: "GANTI_DENGAN_APP_ID_ANDA"
        };

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Firebase berhasil diinisialisasi dan pengguna masuk secara anonim.");
            } catch (error) {
                console.error("Inisialisasi Firebase gagal:", error);
                alert("Tidak dapat terhubung ke layanan kuis. Periksa koneksi internet Anda dan coba lagi.");
            }
        }
        
        // --- FUNCTIONS ---
        window.showView = function(viewId) {
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            window.scrollTo(0, 0);
        }
        
        window.setLanguage = function(lang) {
            window.currentLanguage = lang;
            const t = translations[lang];
            // ... (Kode terjemahan UI lainnya tetap sama)
            Object.keys(t).forEach(key => {
                const el = document.getElementById(key);
                if(el && typeof t[key] === 'string') el.innerText = t[key];
            });
            document.getElementById('teacher-btn-text').innerText = t.teacherBtn;
            document.getElementById('student-btn-text').innerText = t.studentBtn;
            document.getElementById('option-a').placeholder = t.optionPlaceholder('A');
            document.getElementById('option-b').placeholder = t.optionPlaceholder('B');
            document.getElementById('option-c').placeholder = t.optionPlaceholder('C');
            document.getElementById('option-d').placeholder = t.optionPlaceholder('D');
            document.getElementById('publish-quiz-btn').innerText = t.publishBtn;
            document.getElementById('join-quiz-btn').innerText = t.joinQuizBtn;
            document.getElementById('token-input').placeholder = t.tokenInputPlaceholder;
            document.getElementById('player-name').placeholder = t.playerNamePlaceholder;
            document.getElementById('start-quiz-btn-text').innerText = t.startQuizBtn;
            document.getElementById('modal-content').innerHTML = t.modalContent;

            renderQuestionList();
            renderCharacterSelection();
            showView('role-select-view');
        }

        window.addQuestion = function(e) {
            e.preventDefault();
            const question = { id: Date.now(), text: document.getElementById('question-text').value, options: { A: document.getElementById('option-a').value, B: document.getElementById('option-b').value, C: document.getElementById('option-c').value, D: document.getElementById('option-d').value }, answer: document.getElementById('correct-answer').value, points: parseInt(document.getElementById('points').value, 10) };
            window.questions.push(question);
            e.target.reset(); document.getElementById('points').value = 10;
            renderQuestionList();
        }
        
        window.deleteQuestion = function(id) {
            window.questions = window.questions.filter(q => q.id !== id);
            renderQuestionList();
        }

        function renderQuestionList() {
            const questionListDiv = document.getElementById('question-list');
            questionListDiv.innerHTML = '';
            document.getElementById('publish-quiz-btn').disabled = window.questions.length === 0;
            if (window.questions.length === 0) {
                questionListDiv.innerHTML = `<p class="text-gray-500 italic">${window.currentLanguage === 'id' ? 'Belum ada soal ditambahkan.' : 'No questions added yet.'}</p>`;
                return;
            }
            window.questions.forEach((q, index) => {
                const questionEl = document.createElement('div');
                questionEl.className = 'bg-gray-700 p-4 rounded-lg flex justify-between items-start';
                questionEl.innerHTML = `<div class="flex-1"><p class="font-semibold">${index + 1}. ${q.text}</p><p class="text-sm text-green-400 mt-1">${translations[window.currentLanguage].correctAnswerLabel}: ${q.answer} (${q.points} poin)</p></div><button onclick="deleteQuestion(${q.id})" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 text-sm rounded-md ml-4">${translations[window.currentLanguage].deleteBtn}</button>`;
                questionListDiv.appendChild(questionEl);
            });
        }
        
        function generateToken() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let token = '';
            for (let i = 0; i < 6; i++) { token += chars.charAt(Math.floor(Math.random() * chars.length)); }
            return token;
        }

        window.publishQuiz = async function() {
            const btn = document.getElementById('publish-quiz-btn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<span class="loader"></span>`;
            
            const token = generateToken();
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const quizDocRef = doc(db, `artifacts/${appId}/public/data/quizzes`, token);
                await setDoc(quizDocRef, { questions: window.questions, createdAt: serverTimestamp() });

                document.getElementById('quiz-token').innerText = token;
                document.getElementById('copy-token-btn').title = translations[window.currentLanguage].copyBtnTitle;
                showView('token-display-view');
            } catch (e) {
                console.error("Gagal menyimpan kuis ke Firestore", e);
                alert(window.currentLanguage === 'id' ? 'Gagal mempublikasikan kuis. Periksa koneksi internet Anda.' : 'Failed to publish quiz. Check your internet connection.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        window.copyToken = function() {
            const tokenText = document.getElementById('quiz-token').innerText;
            navigator.clipboard.writeText(tokenText).then(() => {
                const copyBtn = document.getElementById('copy-token-btn');
                const originalContent = copyBtn.innerHTML;
                copyBtn.title = translations[window.currentLanguage].copySuccessMsg;
                copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
                setTimeout(() => { copyBtn.innerHTML = originalContent; copyBtn.title = translations[window.currentLanguage].copyBtnTitle; }, 2000);
            });
        }

        window.resetTeacherPanel = function() {
            window.questions = [];
            document.getElementById('add-question-form').reset();
            renderQuestionList();
            showView('teacher-view');
        }

        async function joinQuiz(e) {
            e.preventDefault();
            const btn = document.getElementById('join-quiz-btn');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerHTML = `<span class="loader"></span> <span class="ml-2">${translations[window.currentLanguage].joiningText}</span>`;

            const errorMsgEl = document.getElementById('join-error-msg');
            errorMsgEl.innerText = '';
            const token = document.getElementById('token-input').value.trim().toUpperCase();
            if (!token) {
                btn.disabled = false; btn.innerText = originalText;
                return;
            }

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const quizDocRef = doc(db, `artifacts/${appId}/public/data/quizzes`, token);
                const docSnap = await getDoc(quizDocRef);

                if (docSnap.exists()) {
                    const quizData = docSnap.data();
                    window.studentQuestions = quizData.questions;
                    if (window.studentQuestions && window.studentQuestions.length > 0) {
                        showCharacterSelection();
                    } else {
                        errorMsgEl.innerText = translations[window.currentLanguage].joinErrorMsg;
                    }
                } else {
                    errorMsgEl.innerText = translations[window.currentLanguage].joinErrorMsg;
                }
            } catch (err) {
                console.error("Gagal mengambil kuis dari Firestore", err);
                errorMsgEl.innerText = translations[window.currentLanguage].joinErrorMsg;
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }
        
        function renderCharacterSelection() {
            const grid = document.getElementById('character-grid'); grid.innerHTML = '';
            characters.forEach(char => {
                const charEl = document.createElement('div');
                charEl.className = 'text-center cursor-pointer p-2 bg-gray-700/80 rounded-lg character-card';
                charEl.onclick = () => selectCharacter(char.id, charEl);
                charEl.innerHTML = `<img src="${char.img}" alt="${char.name}" class="w-24 h-24 rounded-full mx-auto mb-2 bg-gray-600 object-cover border-2 border-gray-600"><p class="font-semibold">${char.name}</p>`;
                grid.appendChild(charEl);
            });
        }
        
        window.showCharacterSelection = function() {
            document.getElementById('player-name').value = '';
            document.getElementById('start-quiz-btn').disabled = true;
            window.selectedCharacter = null;
            showView('character-select-view');
        }

        function selectCharacter(charId, element) {
            window.selectedCharacter = characters.find(c => c.id === charId);
            document.querySelectorAll('.character-card').forEach(card => card.classList.remove('selected'));
            element.classList.add('selected');
            document.getElementById('start-quiz-btn').disabled = false;
        }

        window.startQuiz = function() {
            window.playerName = document.getElementById('player-name').value.trim() || window.selectedCharacter.name;
            window.currentQuestionIndex = 0; window.score = 0; window.wronglyAnsweredQuestions = []; window.retryQuestions = []; window.isInRetryRound = false;
            window.maxRetries = window.studentQuestions.length >= 20 ? 3 : (window.studentQuestions.length >= 10 ? 1 : 0);
            window.studentQuestions.sort(() => Math.random() - 0.5);
            showView('student-view');
            displayQuestion();
        }

        function displayQuestion() {
            const t = translations[window.currentLanguage];
            const currentArray = window.isInRetryRound ? window.retryQuestions : window.studentQuestions;
            const question = currentArray[window.currentQuestionIndex];
            document.getElementById('quiz-avatar').src = window.selectedCharacter.img;
            document.getElementById('player-name-display').innerText = window.playerName;
            
            if(window.isInRetryRound) {
                document.getElementById('quiz-title').innerText = t.retryRoundTitle;
                document.getElementById('quiz-progress').innerText = t.retryProgressText(window.currentQuestionIndex + 1, currentArray.length);
                document.getElementById('second-chance-info').style.display = 'none';
            } else {
                document.getElementById('quiz-title').innerText = t.quizTitle;
                document.getElementById('quiz-progress').innerText = t.progressText(window.currentQuestionIndex + 1, currentArray.length);
                document.getElementById('second-chance-info').style.display = 'block';
                document.getElementById('second-chance-info').innerText = `${window.currentLanguage === 'id' ? 'Kesempatan Bonus' : 'Bonus Chances'}: ${window.maxRetries}`;
            }

            document.getElementById('quiz-question').innerText = question.text;
            const optionsDiv = document.getElementById('quiz-options'); optionsDiv.innerHTML = '';
            Object.keys(question.options).forEach(key => {
                const button = document.createElement('button'); button.dataset.key = key;
                button.className = 'w-full text-left bg-gray-700 p-4 rounded-lg hover:bg-blue-600 transition-colors';
                button.innerHTML = `<span class="font-bold mr-2">${key}.</span> ${question.options[key]}`;
                button.onclick = () => selectAnswer(key); optionsDiv.appendChild(button);
            });
        }
        
        function advanceQuiz() {
            window.currentQuestionIndex++;
            const currentArray = window.isInRetryRound ? window.retryQuestions : window.studentQuestions;
            if (window.currentQuestionIndex < currentArray.length) { displayQuestion(); } 
            else { window.isInRetryRound ? showResults() : initiateRetryRound(); }
        }

        function initiateRetryRound() {
            if (window.wronglyAnsweredQuestions.length > 0 && window.maxRetries > 0) {
                window.isInRetryRound = true;
                window.wronglyAnsweredQuestions.sort(() => Math.random() - 0.5);
                window.retryQuestions = window.wronglyAnsweredQuestions.slice(0, window.maxRetries);
                window.currentQuestionIndex = 0;
                displayQuestion();
            } else { showResults(); }
        }

        function selectAnswer(selectedOption) {
            const currentArray = window.isInRetryRound ? window.retryQuestions : window.studentQuestions;
            const question = currentArray[window.currentQuestionIndex];
            const optionsDiv = document.getElementById('quiz-options');
            const buttons = optionsDiv.querySelectorAll('button');
            const selectedBtn = optionsDiv.querySelector(`button[data-key="${selectedOption}"]`);
            const correctBtn = optionsDiv.querySelector(`button[data-key="${question.answer}"]`);

            buttons.forEach(b => { b.disabled = true; b.classList.remove('hover:bg-blue-600'); });

            if (selectedOption === question.answer) {
                window.score += question.points;
                correctBtn.classList.remove('bg-gray-700'); correctBtn.classList.add('bg-green-600');
            } else {
                if (!window.isInRetryRound) { window.wronglyAnsweredQuestions.push(question); }
                selectedBtn.classList.remove('bg-gray-700'); selectedBtn.classList.add('bg-red-600');
                correctBtn.classList.remove('bg-gray-700'); correctBtn.classList.add('bg-green-600');
            }
            setTimeout(advanceQuiz, 1500);
        }

        function showResults() {
            window.isInRetryRound = false; showView('results-view');
            const totalPoints = window.studentQuestions.reduce((sum, q) => sum + q.points, 0);
            document.getElementById('result-character-img').src = window.selectedCharacter.img;
            document.getElementById('result-player-name').innerText = window.playerName;
            document.getElementById('results-title').innerText = translations[window.currentLanguage].resultsTitle;
            document.getElementById('final-score').innerText = `${window.score}`;
            document.getElementById('score-details').innerText = translations[window.currentLanguage].scoreDetails(window.score, totalPoints);
        }
        
        window.showInstructions = function() { document.getElementById('instructions-modal').classList.add('active'); }
        window.closeInstructions = function() { document.getElementById('instructions-modal').classList.remove('active'); }

        function createStars() {
            const container = document.getElementById('stars-container'); if (!container) return;
            for (let i = 0; i < 200; i++) {
                const star = document.createElement('div'); star.className = 'star';
                const size = Math.random() * 2 + 1; star.style.width = `${size}px`; star.style.height = `${size}px`;
                star.style.top = `${Math.random() * 100}%`; star.style.left = `${Math.random() * 100}%`;
                const duration = Math.random() * 6 + 4; const delay = Math.random() * 6;
                star.style.animationDuration = `${duration}s`; star.style.animationDelay = `${delay}s`;
                star.style.animationTimingFunction = 'ease-in-out';
                container.appendChild(star);
            }
        }

        // --- EVENT LISTENERS ---
        document.getElementById('add-question-form').addEventListener('submit', window.addQuestion);
        document.getElementById('join-quiz-form').addEventListener('submit', joinQuiz);

        // --- INITIALIZATION ---
        createStars();
        initializeFirebase();
    </script>
</body>
</html>

