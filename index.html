import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from 'firebase/auth';
import { getFirestore, doc, setDoc, getDoc, addDoc, collection, query, where, getDocs, onSnapshot, updateDoc, arrayUnion, serverTimestamp, deleteDoc } from 'firebase/firestore';

// --- Firebase Configuration ---
// Note: Replace with your Firebase project's configuration.
// __firebase_config is a global variable that will be provided by the Canvas environment
const firebaseConfig = typeof __firebase_config !== 'undefined' 
    ? JSON.parse(__firebase_config)
    : {
        apiKey: "AIzaSyYOUR_API_KEY_HERE",
        authDomain: "your-project-id.firebaseapp.com",
        projectId: "your-project-id",
        storageBucket: "your-project-id.appspot.com",
        messagingSenderId: "your-sender-id",
        appId: "your-app-id"
      };

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- SVG Icons as Components ---
const IconPlus = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
const IconPlay = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>;
const IconEdit = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>;
const IconTrash = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>;
const IconClock = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>;
const IconCheckCircle = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>;
const IconXCircle = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>;
const IconBarChart = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>;
const IconUsers = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>;
const IconLogOut = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>;
const Spinner = () => <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-purple-500"></div>;

// --- Main App Component ---
export default function App() {
    const [page, setPage] = useState('landing');
    const [navParams, setNavParams] = useState({});
    const [user, setUser] = useState(null);
    const [isAuthChecked, setIsAuthChecked] = useState(false);
    const [error, setError] = useState('');

    const navigate = useCallback((pageName, params = {}) => {
        setPage(pageName);
        setNavParams(params);
    }, []);

    useEffect(() => {
        const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
            if (currentUser) {
                const userDocRef = doc(db, "users", currentUser.uid);
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    setUser({ ...currentUser, ...userDoc.data() });
                } else {
                    setUser(currentUser);
                }
            } else {
                setUser(null);
            }
            setIsAuthChecked(true);
        });
        return () => unsubscribe();
    }, []);
    
    useEffect(() => {
        if (!isAuthChecked) return;

        const teacherPages = ['teacherDashboard', 'quizCreator', 'gameHost'];
        const isTeacher = user && user.role === 'teacher';

        if (teacherPages.includes(page) && !isTeacher) {
            navigate('landing');
        }
        
        if (page === 'login' && isTeacher) {
            navigate('teacherDashboard');
        }

    }, [page, user, isAuthChecked, navigate]);

    const handleSignOut = async () => {
        await signOut(auth);
        setUser(null);
        navigate('landing');
    };

    const renderPage = () => {
        if (!isAuthChecked) {
            return <div className="flex items-center justify-center h-screen"><Spinner /></div>;
        }

        switch (page) {
            case 'login':
                return <LoginPage navigate={navigate} setError={setError} />;
            case 'teacherDashboard':
                return <TeacherDashboard user={user} navigate={navigate} handleSignOut={handleSignOut} />;
            case 'quizCreator':
                return <QuizCreator user={user} navigate={navigate} quizId={navParams.quizId} />;
            case 'gameLobby':
                return <GameLobby navigate={navigate} user={user} gameCode={navParams.code} />;
            case 'gameHost':
                return <GameHost navigate={navigate} user={user} gameCode={navParams.code}/>;
            case 'studentJoin':
                return <StudentJoin navigate={navigate} initialCode={navParams.code} />;
            case 'studentGame':
                return <StudentGameView gameCode={navParams.code} navigate={navigate} />;
            case 'landing':
            default:
                return <LandingPage navigate={navigate} user={user} handleSignOut={handleSignOut} />;
        }
    };

    return (
        <div className="bg-gray-50 min-h-screen font-sans text-gray-800">
            {error && <div className="bg-red-500 text-white p-3 text-center fixed top-0 w-full z-50" onClick={() => setError('')}>{error}</div>}
            {renderPage()}
        </div>
    );
}

// --- Pages (Components) ---

function LandingPage({ navigate, user, handleSignOut }) {
    const [gameCodeInput, setGameCodeInput] = useState('');

    const handleJoinGame = (e) => {
        e.preventDefault();
        if (gameCodeInput.trim()) {
            navigate('studentJoin', { code: gameCodeInput.trim() });
        }
    };

    return (
        <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-purple-500 to-indigo-600 text-white p-4">
            <div className="absolute top-4 right-4">
                {user && user.role === 'teacher' ? (
                    <div className="flex items-center space-x-4">
                        <button onClick={() => navigate('teacherDashboard')} className="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-md font-semibold transition">Dashboard Guru</button>
                        <button onClick={handleSignOut} className="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-md font-semibold transition">Keluar</button>
                    </div>
                ) : (
                    <button onClick={() => navigate('login')} className="bg-white text-purple-600 hover:bg-gray-100 px-6 py-2 rounded-md font-bold transition shadow-lg">Masuk / Daftar sebagai Guru</button>
                )}
            </div>

            <main className="text-center">
                <h1 className="text-6xl md:text-8xl font-extrabold tracking-tight mb-4 animate-fade-in-down">EduKuis</h1>
                <p className="text-xl md:text-2xl mb-8 max-w-2xl mx-auto animate-fade-in-up">Platform kuis interaktif yang membuat belajar menjadi seru dan kompetitif. Gabung sekarang!</p>
                
                <div className="bg-white rounded-lg shadow-2xl p-6 md:p-8 w-full max-w-md mx-auto animate-zoom-in">
                    <form onSubmit={handleJoinGame}>
                        <input
                            type="text"
                            placeholder="Masukkan Kode Game"
                            value={gameCodeInput}
                            onChange={(e) => setGameCodeInput(e.target.value.toUpperCase())}
                            className="w-full px-6 py-4 text-2xl text-center text-gray-700 border-2 border-gray-300 rounded-md focus:outline-none focus:ring-4 focus:ring-purple-300 transition"
                        />
                        <button type="submit" className="w-full mt-4 bg-green-500 hover:bg-green-600 text-white font-bold text-xl py-4 rounded-md transition transform hover:scale-105 shadow-lg">
                            Gabung
                        </button>
                    </form>
                </div>
            </main>
        </div>
    );
}

function LoginPage({ navigate, setError }) {
    const [isLogin, setIsLogin] = useState(true);
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [fullName, setFullName] = useState('');

    const handleAuth = async (e) => {
        e.preventDefault();
        setError('');
        try {
            if (isLogin) {
                await signInWithEmailAndPassword(auth, email, password);
            } else {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "users", userCredential.user.uid), {
                    email: userCredential.user.email,
                    fullName: fullName,
                    role: 'teacher',
                    createdAt: serverTimestamp()
                });
            }
            navigate('teacherDashboard');
        } catch (err) {
            setError(err.message);
        }
    };
    
    return (
        <div className="flex items-center justify-center min-h-screen bg-gray-100">
            <div className="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
                <h2 className="text-3xl font-bold text-center text-gray-900">{isLogin ? 'Masuk Akun Guru' : 'Daftar Akun Guru'}</h2>
                <form className="space-y-6" onSubmit={handleAuth}>
                    {!isLogin && (
                         <div>
                            <input type="text" value={fullName} onChange={(e) => setFullName(e.target.value)} placeholder="Nama Lengkap" required className="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" />
                        </div>
                    )}
                    <div>
                        <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="Email" required className="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" />
                    </div>
                    <div>
                        <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="Kata Sandi" required className="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" />
                    </div>
                    <button type="submit" className="w-full px-4 py-2 font-bold text-white bg-purple-600 rounded-md hover:bg-purple-700 transition">{isLogin ? 'Masuk' : 'Daftar'}</button>
                </form>
                <div className="my-6"></div>
                <p className="text-sm text-center text-gray-600">
                    {isLogin ? "Belum punya akun?" : "Sudah punya akun?"}
                    <button onClick={() => setIsLogin(!isLogin)} className="ml-1 font-medium text-purple-600 hover:text-purple-500">{isLogin ? 'Daftar di sini' : 'Masuk di sini'}</button>
                </p>
                <button onClick={() => navigate('landing')} className="text-sm text-center w-full text-gray-500 hover:text-gray-700">Kembali ke Beranda</button>
            </div>
        </div>
    );
}


function TeacherDashboard({ user, navigate, handleSignOut }) {
    const [quizzes, setQuizzes] = useState([]);
    const [loading, setLoading] = useState(true);

    const fetchQuizzes = useCallback(async () => {
        if (!user) return;
        setLoading(true);
        try {
            const q = query(collection(db, 'quizzes'), where('creatorId', '==', user.uid));
            const querySnapshot = await getDocs(q);
            const userQuizzes = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setQuizzes(userQuizzes);
        } catch (error) {
            console.error("Error fetching quizzes:", error);
        } finally {
            setLoading(false);
        }
    }, [user]);

    useEffect(() => {
        fetchQuizzes();
    }, [fetchQuizzes]);
    
    const startLiveQuiz = async (quizId) => {
        const gameCode = Math.floor(100000 + Math.random() * 900000).toString();
        const quiz = quizzes.find(q => q.id === quizId);
        await setDoc(doc(db, "gameSessions", gameCode), {
            quizId,
            quizTitle: quiz.title,
            creatorId: user.uid,
            status: 'lobby',
            currentQuestion: -1,
            players: [],
            questions: quiz.questions,
            createdAt: serverTimestamp()
        });
        navigate('gameLobby', { code: gameCode });
    };

    const deleteQuiz = async (quizId) => {
        // Optional: Add a confirmation dialog here in a real app
        if (window.confirm("Apakah Anda yakin ingin menghapus kuis ini?")) {
            await deleteDoc(doc(db, "quizzes", quizId));
            fetchQuizzes(); // Refresh the list
        }
    };

    return (
        <div className="container mx-auto p-4 md:p-8">
            <header className="flex justify-between items-center mb-8">
                <div>
                    <h1 className="text-3xl font-bold">Dashboard Guru</h1>
                    <p className="text-gray-500">Selamat datang, {user?.fullName || user?.displayName || user?.email}!</p>
                </div>
                <div className="flex items-center space-x-4">
                    <button onClick={() => navigate('quizCreator')} className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2 transition shadow-md">
                        <IconPlus /> <span>Buat Kuis Baru</span>
                    </button>
                    <button onClick={handleSignOut} title="Keluar" className="bg-red-500 hover:bg-red-600 text-white p-2 rounded-full transition shadow-md">
                        <IconLogOut />
                    </button>
                </div>
            </header>

            <div className="bg-white p-6 rounded-lg shadow-md">
                <h2 className="text-2xl font-semibold mb-4">Kuis Saya</h2>
                {loading ? <div className="flex justify-center"><Spinner /></div> : (
                    <div className="space-y-4">
                        {quizzes.length > 0 ? quizzes.map(quiz => (
                            <div key={quiz.id} className="border p-4 rounded-lg flex flex-wrap justify-between items-center gap-4 hover:bg-gray-50 transition">
                                <div>
                                    <h3 className="text-xl font-bold">{quiz.title}</h3>
                                    <p className="text-sm text-gray-500">{quiz.questions.length} Pertanyaan</p>
                                </div>
                                <div className="flex space-x-2">
                                    <button onClick={() => startLiveQuiz(quiz.id)} className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2">
                                        <IconPlay /> <span>Mulai Live</span>
                                    </button>
                                     <button onClick={() => navigate('quizCreator', { quizId: quiz.id })} className="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-lg" title="Edit Kuis">
                                        <IconEdit />
                                    </button>
                                     <button onClick={() => deleteQuiz(quiz.id)} className="bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg" title="Hapus Kuis">
                                        <IconTrash />
                                    </button>
                                </div>
                            </div>
                        )) : (
                            <p className="text-center text-gray-500 py-8">Anda belum membuat kuis. Ayo buat yang pertama!</p>
                        )}
                    </div>
                )}
            </div>
        </div>
    );
}

function QuizCreator({ user, navigate, quizId }) {
    const [title, setTitle] = useState('');
    const [questions, setQuestions] = useState([
        { text: '', options: ['', '', '', ''], correctOption: 0, time: 30 }
    ]);
    const [isSaving, setIsSaving] = useState(false);

    useEffect(() => {
        if (quizId) {
            const fetchQuiz = async () => {
                const quizDoc = await getDoc(doc(db, 'quizzes', quizId));
                if (quizDoc.exists()) {
                    const data = quizDoc.data();
                    setTitle(data.title);
                    setQuestions(data.questions);
                }
            };
            fetchQuiz();
        }
    }, [quizId]);

    const handleQuestionChange = (index, field, value) => {
        const newQuestions = [...questions];
        newQuestions[index][field] = value;
        setQuestions(newQuestions);
    };

    const handleOptionChange = (qIndex, oIndex, value) => {
        const newQuestions = [...questions];
        newQuestions[qIndex].options[oIndex] = value;
        setQuestions(newQuestions);
    };

    const addQuestion = () => {
        setQuestions([...questions, { text: '', options: ['', '', '', ''], correctOption: 0, time: 30 }]);
    };
    
    const removeQuestion = (index) => {
        if (questions.length > 1) {
            const newQuestions = questions.filter((_, i) => i !== index);
            setQuestions(newQuestions);
        }
    };

    const saveQuiz = async () => {
        if (!title.trim()) {
            alert("Judul kuis tidak boleh kosong.");
            return;
        }
        setIsSaving(true);
        try {
            const quizData = {
                title,
                questions,
                creatorId: user.uid,
                updatedAt: serverTimestamp()
            };
            if(quizId){
                await setDoc(doc(db, 'quizzes', quizId), quizData, { merge: true });
            } else {
                quizData.createdAt = serverTimestamp();
                await addDoc(collection(db, 'quizzes'), quizData);
            }
            navigate('teacherDashboard');
        } catch (error) {
            console.error("Error saving quiz:", error);
        } finally {
            setIsSaving(false);
        }
    };

    return (
        <div className="container mx-auto p-8">
             <header className="flex justify-between items-center mb-6">
                <h1 className="text-3xl font-bold">{quizId ? 'Edit Kuis' : 'Buat Kuis Baru'}</h1>
                <div>
                     <button onClick={() => navigate('teacherDashboard')} className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg mr-2">
                        Batal
                    </button>
                    <button onClick={saveQuiz} disabled={isSaving} className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg disabled:bg-gray-400">
                        {isSaving ? 'Menyimpan...' : 'Simpan Kuis'}
                    </button>
                </div>
            </header>
            
            <div className="bg-white p-6 rounded-lg shadow-md mb-6">
                <input
                    type="text"
                    value={title}
                    onChange={(e) => setTitle(e.target.value)}
                    placeholder="Judul Kuis"
                    className="w-full text-2xl font-bold p-2 border-b-2 focus:outline-none focus:border-purple-500"
                />
            </div>

            {questions.map((q, qIndex) => (
                <div key={qIndex} className="bg-white p-6 rounded-lg shadow-md mb-4 relative">
                    <div className="flex justify-between items-start">
                        <h3 className="text-xl font-semibold mb-4">Pertanyaan {qIndex + 1}</h3>
                        <button onClick={() => removeQuestion(qIndex)} className="text-red-500 hover:text-red-700" title="Hapus Pertanyaan">
                            <IconTrash />
                        </button>
                    </div>
                    <textarea
                        value={q.text}
                        onChange={(e) => handleQuestionChange(qIndex, 'text', e.target.value)}
                        placeholder="Ketik pertanyaan di sini..."
                        className="w-full p-2 border rounded-md mb-4"
                        rows="3"
                    ></textarea>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        {q.options.map((opt, oIndex) => (
                             <div key={oIndex} className="flex items-center space-x-2">
                                 <input
                                    type="radio"
                                    name={`correct-option-${qIndex}`}
                                    checked={q.correctOption === oIndex}
                                    onChange={() => handleQuestionChange(qIndex, 'correctOption', oIndex)}
                                    className="form-radio h-5 w-5 text-green-500 focus:ring-green-500"
                                />
                                <input
                                    type="text"
                                    value={opt}
                                    onChange={(e) => handleOptionChange(qIndex, oIndex, e.target.value)}
                                    placeholder={`Pilihan ${oIndex + 1}`}
                                    className="w-full p-2 border rounded-md focus:ring-purple-500 focus:border-purple-500"
                                />
                             </div>
                        ))}
                    </div>

                    <div className="flex items-center space-x-2 text-sm text-gray-600">
                        <IconClock />
                        <span>Waktu Jawab (detik):</span>
                        <input
                            type="number"
                            value={q.time}
                            onChange={(e) => handleQuestionChange(qIndex, 'time', parseInt(e.target.value))}
                            className="w-20 p-1 border rounded-md"
                        />
                    </div>
                </div>
            ))}

            <button onClick={addQuestion} className="w-full bg-blue-100 hover:bg-blue-200 text-blue-800 font-bold py-3 px-4 rounded-lg mt-4 flex items-center justify-center space-x-2">
                <IconPlus /> <span>Tambah Pertanyaan</span>
            </button>
        </div>
    );
}

function GameLobby({ navigate, gameCode, user }) {
    const [session, setSession] = useState(null);
    const [loading, setLoading] = useState(true);
    const isHost = !!user;

    useEffect(() => {
        if (!gameCode) return;
        
        const sessionRef = doc(db, "gameSessions", gameCode);
        const unsubscribe = onSnapshot(sessionRef, (doc) => {
            if (doc.exists()) {
                const sessionData = doc.data();
                setSession({ id: doc.id, ...sessionData });
                if(sessionData.status === 'in-progress'){
                    if(isHost) navigate('gameHost', { code: gameCode});
                    else navigate('studentGame', { code: gameCode});
                }
            } else {
                 setSession(null);
            }
            setLoading(false);
        });

        return () => unsubscribe();
    }, [gameCode, navigate, isHost]);

    const startGame = async () => {
        if(session){
            await updateDoc(doc(db, 'gameSessions', gameCode), {
                status: 'in-progress',
                currentQuestion: 0,
            });
            navigate('gameHost', { code: gameCode});
        }
    };

    if (loading) return <div className="flex items-center justify-center h-screen"><Spinner /></div>;
    if (!session) return <div className="flex flex-col items-center justify-center h-screen text-xl"><p>Game tidak ditemukan.</p><button onClick={()=>navigate('landing')} className="mt-4 bg-purple-600 text-white px-4 py-2 rounded-lg">Kembali ke Beranda</button></div>;

    return (
        <div className="flex flex-col items-center justify-center min-h-screen bg-purple-700 text-white p-4">
            <h1 className="text-3xl font-bold mb-2">Lobi Permainan</h1>
            <p className="text-xl mb-6">Kuis: {session.quizTitle}</p>
            
            <div className="bg-white text-gray-800 p-6 rounded-lg text-center shadow-lg mb-8">
                <p className="text-lg">Bagikan kode ini ke murid:</p>
                <p className="text-6xl font-extrabold tracking-widest my-2">{gameCode}</p>
            </div>

            <div className="w-full max-w-2xl bg-white/20 p-6 rounded-lg">
                 <h2 className="text-2xl font-bold mb-4 text-center flex items-center justify-center"><IconUsers className="mr-2" /> Peserta ({session.players.length})</h2>
                 <div className="grid grid-cols-2 md:grid-cols-4 gap-4 max-h-40 overflow-y-auto">
                     {session.players.map((player, index) => (
                         <div key={index} className="bg-white text-gray-800 font-semibold p-3 rounded-md text-center shadow">
                             {player.nickname}
                         </div>
                     ))}
                 </div>
                 {session.players.length === 0 && <p className="text-center text-white/70 mt-4">Menunggu peserta bergabung...</p>}
            </div>

            {isHost && (
                <button onClick={startGame} className="mt-8 bg-green-500 hover:bg-green-600 text-white font-bold text-xl py-4 px-12 rounded-lg transition transform hover:scale-105 shadow-lg">
                    Mulai Kuis!
                </button>
            )}
            {!isHost && (
                <div className="mt-8 text-center">
                    <p className="text-xl animate-pulse">Menunggu guru memulai kuis...</p>
                </div>
            )}
        </div>
    );
}

function StudentJoin({ navigate, initialCode }) {
    const [nickname, setNickname] = useState('');
    const [localGameCode, setLocalGameCode] = useState(initialCode || '');
    const [error, setError] = useState('');

    const joinGame = async (e) => {
        e.preventDefault();
        setError('');
        if (!nickname.trim() || !localGameCode.trim()) {
            setError("Nama panggilan dan kode game harus diisi.");
            return;
        }

        const gameRef = doc(db, "gameSessions", localGameCode);
        const gameDoc = await getDoc(gameRef);

        if (!gameDoc.exists()) {
            setError("Kode game tidak ditemukan.");
            return;
        }
        
        // Generate a unique ID for the student for this session
        const studentId = `student_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        sessionStorage.setItem(`eduKuis_${localGameCode}_studentId`, studentId);


        await updateDoc(gameRef, {
            players: arrayUnion({
                id: studentId,
                nickname: nickname,
                score: 0,
                answers: {} // Use an object for answers: { qIndex: answerData }
            })
        });
        
        navigate('gameLobby', { code: localGameCode });
    };

    return (
        <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-400 to-teal-500">
            <div className="w-full max-w-sm p-8 space-y-6 bg-white rounded-lg shadow-xl">
                 <h2 className="text-3xl font-bold text-center text-gray-900">Gabung Kuis</h2>
                 {error && <p className="text-red-500 text-center">{error}</p>}
                 <form className="space-y-4" onSubmit={joinGame}>
                     <div>
                         <input
                            type="text"
                            placeholder="Kode Game"
                            value={localGameCode}
                            onChange={(e) => setLocalGameCode(e.target.value.toUpperCase())}
                            required
                            className="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-center text-xl"
                         />
                     </div>
                      <div>
                         <input
                            type="text"
                            placeholder="Nama Panggilan"
                            value={nickname}
                            onChange={(e) => setNickname(e.target.value)}
                            required
                            className="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-center text-xl"
                         />
                     </div>
                     <button type="submit" className="w-full px-4 py-3 font-bold text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition">
                         Gabung
                     </button>
                 </form>
                 <button onClick={() => navigate('landing')} className="text-sm text-center w-full text-gray-500 hover:text-gray-700">Kembali</button>
            </div>
        </div>
    );
}

function StudentGameView({ gameCode, navigate }) {
    const [session, setSession] = useState(null);
    const [player, setPlayer] = useState(null);
    const [timeLeft, setTimeLeft] = useState(0);
    const [selectedAnswer, setSelectedAnswer] = useState(null);
    const [answerResult, setAnswerResult] = useState(null); // 'correct', 'incorrect', or null
    
    const studentId = useMemo(() => sessionStorage.getItem(`eduKuis_${gameCode}_studentId`), [gameCode]);

    useEffect(() => {
        if (!gameCode || !studentId) {
            navigate('landing');
            return;
        };

        const sessionRef = doc(db, "gameSessions", gameCode);
        const unsubscribe = onSnapshot(sessionRef, (doc) => {
            if (doc.exists()) {
                const sessionData = doc.data();
                setSession(sessionData);

                const currentPlayer = sessionData.players.find(p => p.id === studentId);
                setPlayer(currentPlayer);

                if (sessionData.status === 'finished') return;

                const currentQIndex = sessionData.currentQuestion;
                if (!currentPlayer) return;
                const hasAnswered = currentPlayer.answers && currentPlayer.answers[currentQIndex];

                if (sessionData.view === 'question' && !hasAnswered) {
                    setSelectedAnswer(null);
                    setAnswerResult(null);
                    setTimeLeft(sessionData.questions[currentQIndex].time);
                }
                
                if (sessionData.view === 'result') {
                    if(hasAnswered) {
                        setAnswerResult(currentPlayer.answers[currentQIndex].isCorrect ? 'correct' : 'incorrect');
                    } else {
                        setAnswerResult('incorrect'); // Timed out
                    }
                }

            } else {
                navigate('landing');
            }
        });
        return () => unsubscribe();
    }, [gameCode, studentId, navigate]);

    useEffect(() => {
        if (timeLeft > 0 && session?.view === 'question') {
            const timer = setTimeout(() => setTimeLeft(timeLeft - 1), 1000);
            return () => clearTimeout(timer);
        }
    }, [timeLeft, session]);
    
    const handleAnswer = async (optionIndex) => {
        if (selectedAnswer !== null) return; // Already answered
        setSelectedAnswer(optionIndex);

        const currentQIndex = session.currentQuestion;
        const question = session.questions[currentQIndex];
        const isCorrect = question.correctOption === optionIndex;
        const scoreGained = isCorrect ? 100 + (timeLeft * 5) : 0;
        
        const gameRef = doc(db, "gameSessions", gameCode);
        const gameDoc = await getDoc(gameRef);
        const currentPlayers = gameDoc.data().players;
        
        const newPlayers = currentPlayers.map(p => {
           if (p.id === studentId) {
                return {
                    ...p,
                    score: p.score + scoreGained,
                    answers: {
                        ...p.answers,
                        [currentQIndex]: {
                            option: optionIndex,
                            isCorrect,
                            scoreGained,
                            time: question.time - timeLeft
                        }
                    }
                };
            }
            return p;
        });
        
        await updateDoc(gameRef, { players: newPlayers });
    };

    if (!session || !player) return <div className="flex items-center justify-center h-screen"><Spinner /></div>;

    if (session.status === 'finished') {
        const sortedPlayers = [...session.players].sort((a, b) => b.score - a.score);
        const playerRank = sortedPlayers.findIndex(p => p.id === studentId) + 1;
        return (
            <div className="flex flex-col items-center justify-center min-h-screen bg-gray-800 text-white p-4">
                <h1 className="text-4xl font-bold mb-4">Kuis Selesai!</h1>
                <div className="bg-white/20 p-8 rounded-lg text-center">
                    <p className="text-2xl">Peringkat Anda:</p>
                    <p className="text-7xl font-bold my-2">{playerRank}</p>
                    <p className="text-3xl">Skor Akhir: {player.score}</p>
                </div>
                 <button onClick={() => navigate('landing')} className="mt-8 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg">
                    Kembali ke Beranda
                </button>
            </div>
        );
    }
    
    const currentQIndex = session.currentQuestion;
    if (currentQIndex < 0 || currentQIndex >= session.questions.length) {
        return <div className="flex items-center justify-center h-screen bg-gray-900 text-white"><p>Menunggu kuis dimulai...</p></div>;
    }
    const question = session.questions[currentQIndex];

    const colors = ["bg-red-500", "bg-blue-500", "bg-yellow-500", "bg-green-500"];
    const hoverColors = ["hover:bg-red-600", "hover:bg-blue-600", "hover:bg-yellow-600", "hover:bg-green-600"];

    return (
        <div className="flex flex-col h-screen bg-gray-900 text-white">
            <header className="flex justify-between items-center p-4 bg-gray-800">
                <div className="text-lg">Soal {currentQIndex + 1} dari {session.questions.length}</div>
                <div className="text-2xl font-bold">{player.nickname}</div>
                <div className="text-xl font-bold">Skor: {player.score}</div>
            </header>

            <main className="flex-grow flex flex-col items-center justify-center p-4 text-center">
                {session.view === 'question' && (
                    <>
                        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-9xl font-bold text-white/10">{timeLeft}</div>
                        <h2 className="text-3xl font-bold mb-8">{question.text}</h2>
                        <div className="w-full max-w-4xl grid grid-cols-2 gap-4">
                           {question.options.map((opt, i) => (
                                <button
                                    key={i}
                                    disabled={selectedAnswer !== null}
                                    onClick={() => handleAnswer(i)}
                                    className={`p-6 rounded-lg text-xl font-semibold transition ${colors[i]} ${selectedAnswer === null ? hoverColors[i] : ''} ${selectedAnswer !== null && selectedAnswer !== i ? 'opacity-50' : ''} ${selectedAnswer === i ? 'ring-4 ring-white' : ''}`}
                                >
                                    {opt}
                                </button>
                            ))}
                        </div>
                    </>
                )}
                 {session.view === 'result' && (
                    <div className="flex flex-col items-center">
                         <div className={`mb-8 p-4 rounded-lg ${answerResult === 'correct' ? 'bg-green-500' : 'bg-red-500'}`}>
                             <h2 className="text-4xl font-bold">{answerResult === 'correct' ? 'Benar!' : 'Salah'}</h2>
                         </div>
                         <p className="text-2xl">Menunggu soal berikutnya...</p>
                    </div>
                 )}
                 {session.view === 'leaderboard' && (
                     <div>
                        <h2 className="text-4xl font-bold mb-4">Papan Peringkat</h2>
                         <div className="w-full max-w-md bg-white/10 rounded-lg p-4">
                            {[...session.players].sort((a,b) => b.score - a.score).slice(0, 5).map((p, i) => (
                                <div key={p.id} className={`flex justify-between p-2 rounded ${p.id === studentId ? 'bg-purple-600' : ''}`}>
                                    <span>{i + 1}. {p.nickname}</span>
                                    <span>{p.score}</span>
                                </div>
                            ))}
                        </div>
                     </div>
                 )}
            </main>
        </div>
    );
}

function GameHost({ gameCode, navigate }) {
    const [session, setSession] = useState(null);

    useEffect(() => {
        if (!gameCode) return;
        const sessionRef = doc(db, "gameSessions", gameCode);
        const unsubscribe = onSnapshot(sessionRef, (doc) => {
            if (doc.exists()) {
                setSession(doc.data());
            } else {
                navigate('teacherDashboard');
            }
        });
        return () => unsubscribe();
    }, [gameCode, navigate]);

    const nextStep = async () => {
        const gameRef = doc(db, "gameSessions", gameCode);
        
        if (session.view === 'question') {
            await updateDoc(gameRef, { view: 'result' });
        } else if (session.view === 'result') {
            await updateDoc(gameRef, { view: 'leaderboard' });
        } else if (session.view === 'leaderboard') {
            const nextQuestionIndex = session.currentQuestion + 1;
            if (nextQuestionIndex < session.questions.length) {
                await updateDoc(gameRef, {
                    currentQuestion: nextQuestionIndex,
                    view: 'question'
                });
            } else {
                 await updateDoc(gameRef, { status: 'finished' });
            }
        } else { // First question
             await updateDoc(gameRef, {
                currentQuestion: 0,
                view: 'question'
            });
        }
    };
    
    const endGame = async () => {
        if (window.confirm("Apakah Anda yakin ingin mengakhiri kuis ini sekarang?")) {
            await updateDoc(doc(db, "gameSessions", gameCode), { status: 'finished' });
        }
    };

    if (!session) return <div className="flex items-center justify-center h-screen"><Spinner /></div>;
    
    if (session.status === 'finished') {
         const sortedPlayers = [...session.players].sort((a, b) => b.score - a.score);
        return (
            <div className="flex flex-col items-center justify-center min-h-screen bg-gray-800 text-white p-4">
                 <h1 className="text-4xl font-bold mb-4">Kuis Selesai!</h1>
                 <h2 className="text-3xl mb-6">Hasil Akhir</h2>
                 <div className="w-full max-w-md bg-white/10 rounded-lg p-4">
                    {sortedPlayers.map((p, i) => (
                        <div key={p.id} className="flex justify-between p-2 rounded text-lg">
                            <span>{i + 1}. {p.nickname}</span>
                            <span>{p.score}</span>
                        </div>
                    ))}
                </div>
                <button onClick={() => navigate('teacherDashboard')} className="mt-8 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg">
                    Kembali ke Dashboard
                </button>
            </div>
        )
    }

    const currentQIndex = session.currentQuestion;
    const question = currentQIndex >= 0 ? session.questions[currentQIndex] : null;
    const answersCount = question ? session.players.filter(p => p.answers && p.answers[currentQIndex]).length : 0;
    
    return (
        <div className="flex flex-col h-screen bg-gray-900 text-white">
            <header className="flex justify-between items-center p-4 bg-gray-800">
                <div className="text-lg">Game Code: <span className="font-bold">{gameCode}</span></div>
                <div className="text-xl font-bold">{session.quizTitle}</div>
                <div className="flex items-center space-x-4">
                    <div className="text-lg flex items-center"><IconUsers className="mr-2"/>{session.players.length}</div>
                    <button onClick={endGame} className="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">
                        Akhiri Kuis
                    </button>
                </div>
            </header>

            <main className="flex-grow flex flex-col items-center justify-center p-4 text-center">
                 {currentQIndex < 0 && (
                    <div className="text-center">
                        <h2 className="text-4xl font-bold mb-4">Kuis akan dimulai!</h2>
                        <p className="text-2xl">Bersiaplah...</p>
                    </div>
                )}
                {session.view === 'question' && question && (
                    <>
                        <p className="text-xl mb-2">Soal {currentQIndex + 1} / {session.questions.length}</p>
                        <h2 className="text-4xl font-bold mb-8">{question.text}</h2>
                        <div className="w-full max-w-2xl bg-white/10 p-4 rounded-lg">
                            <p className="text-2xl">{answersCount} / {session.players.length} Jawaban</p>
                        </div>
                    </>
                )}
                {session.view === 'result' && question && (
                     <>
                        <h2 className="text-4xl font-bold mb-8">Jawaban yang Benar:</h2>
                        <div className="bg-green-500 p-6 rounded-lg text-2xl font-bold">
                            {question.options[question.correctOption]}
                        </div>
                    </>
                )}
                {session.view === 'leaderboard' && (
                    <div>
                        <h2 className="text-4xl font-bold mb-4">Papan Peringkat</h2>
                         <div className="w-full max-w-md bg-white/10 rounded-lg p-4">
                            {[...session.players].sort((a,b) => b.score - a.score).slice(0, 5).map((p, i) => (
                                <div key={p.id} className="flex justify-between p-2 rounded text-lg">
                                    <span>{i + 1}. {p.nickname}</span>
                                    <span>{p.score}</span>
                                </div>
                            ))}
                        </div>
                     </div>
                )}
            </main>
            
             <footer className="p-4 bg-gray-800 flex justify-end">
                <button onClick={nextStep} className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg text-xl">
                    {currentQIndex < 0 && 'Mulai'}
                    {session.view === 'question' && 'Tampilkan Jawaban'}
                    {session.view === 'result' && 'Papan Peringkat'}
                    {session.view === 'leaderboard' && (currentQIndex + 1 < session.questions.length ? 'Soal Berikutnya' : 'Lihat Hasil Akhir')}
                </button>
            </footer>
        </div>
    );
}
